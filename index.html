<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æªä½ å¥åº· æœå‹™ç´€éŒ„ç”¢ç”Ÿå™¨ï¼ˆå€å¡ŠåŒ–ç‰ˆæœ¬ï¼‰</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; max-width: 600px; margin: auto; }
.block-title { margin-top: 30px; cursor: pointer; background: #ccc; padding: 12px; font-size: 18px; font-weight: bold; }
h3 { margin-top: 20px; cursor: pointer; background: #eee; padding: 10px; font-size: 16px; }
.section, .block-section { display: none; margin-bottom: 20px; }
.item { margin-bottom: 12px; display: flex; align-items: center; flex-wrap: wrap; }
.item label { flex: 1 1 120px; }
.item input[type="text"], .item input[type="date"], .item select { flex: 2 1 200px; margin-left: 5px; }
textarea { width: 100%; height: 200px; }
button { margin: 10px 0; padding: 10px 20px; width: 100%; }
</style>
</head>
<body>

<h1>æªä½ å¥åº· æœå‹™ç´€éŒ„ç”¢ç”Ÿå™¨</h1>

<div id="form"></div>

<button onclick="generate()">ç”¢ç”Ÿæ–‡æ¡ˆ</button>
<button onclick="copyText()">è¤‡è£½æ–‡æ¡ˆ</button>

<h2>ç”Ÿæˆæ–‡æ¡ˆ</h2>
<textarea id="output"></textarea>

<script>
const blocks = [
  {
    title: "åŸºæœ¬è³‡æ–™",
    sections: [
      ["åŸºæœ¬è³‡æ–™", ["å®¢æˆ¶åç¨±", "ç‰©ç†æ²»ç™‚å¸«åç¨±", "æœå‹™æ—¥æœŸ", "æ˜¯å¦ç‚ºç¬¬ä¸€æ¬¡æœå‹™"]]
    ]
  },
  {
    title: "ä¸»è¨´èˆ‡è©•ä¼°",
    sections: [
      ["å®¢æˆ¶ä¸»è¨´", ["é ¸éƒ¨", "èƒŒéƒ¨", "è…°éƒ¨", "è…¹éƒ¨", "è‚©è†€", "æ‰‹è‚˜", "æ‰‹è…•", "é«–", "è†", "è¸", "å…¶ä»–"]],
      ["éœæ…‹è©•ä¼°", ["è„–å­å‰å‚¾", "é«˜ä½è‚©", "é§èƒŒ", "è…°æ¤å‰å‡¸", "è„ŠæŸ±å´å½", "éª¨ç›†å‰å‚¾", "éª¨ç›†å¾Œå‚¾", "é•·çŸ­è…³", "è†å…§ç¿»", "è†å¤–ç¿»", "è¶³å…§ç¿»", "è¶³å¤–ç¿»", "æ‰å¹³è¶³", "é«˜å¼“è¶³", "å…¶ä»–"]],
      ["æ´»å‹•åº¦ä¸è¶³", ["é ¸éƒ¨", "èƒŒéƒ¨", "è…°éƒ¨", "è…¹éƒ¨", "è‚©è†€", "æ‰‹è‚˜", "æ‰‹è…•", "é«–", "è†", "è¸", "å…¶ä»–"]],
      ["è‚Œè€åŠ›ä¸è¶³/åŠŸèƒ½å¤±å¸¸", ["é ¸æ·±è‚Œç¾¤", "è…¹éƒ¨æ ¸å¿ƒ", "éª¨ç›†åº•è‚Œ", "æ·±è‡€è‚Œç¾¤", "å¤§è…¿å‰å´", "å¤§è…¿å¾Œå´", "å¤§è…¿å…§å´", "å¤§è…¿å¤–å´", "å°è…¿å‰å´", "å°è…¿å¾Œå´", "å°è…¿å…§å´", "å°è…¿å¤–å´", "è¶³åº•", "å…¶ä»–"]],
      ["ç·Šç¹ƒç­‹è†œ", ["è‚©é ¸ç­‹è†œ", "èƒ¸è…°ç­‹è†œ", "æ‰‹è‡‚ç­‹è†œ", "è…¹éƒ¨ç­‹è†œ", "å¤§è…¿å‰å´", "å¤§è…¿å¾Œå´", "å¤§è…¿å…§å´", "å¤§è…¿å¤–å´", "å°è…¿å‰å´", "å°è…¿å¾Œå´", "å°è…¿å…§å´", "å°è…¿å¤–å´", "è‡€éƒ¨ç­‹è†œ", "è†é—œç¯€", "è¶³åº•", "å…¶ä»–"]]
    ]
  },
  {
    title: "æœ¬æ¬¡è™•ç†",
    sections: [
      ["æ”¾é¬†", ["è‚©é ¸ç­‹è†œ", "èƒ¸è…°ç­‹è†œ", "æ‰‹è‡‚ç­‹è†œ", "è…¹éƒ¨ç­‹è†œ", "å¤§è…¿å‰å´", "å¤§è…¿å¾Œå´", "å¤§è…¿å…§å´", "å¤§è…¿å¤–å´", "å°è…¿å‰å´", "å°è…¿å¾Œå´", "å°è…¿å…§å´", "å°è…¿å¤–å´", "è‡€éƒ¨ç­‹è†œ", "è†é—œç¯€", "è¶³åº•", "å…¶ä»–"]],
      ["ä¼¸å±•", ["è‚©é ¸ç­‹è†œ", "èƒ¸è…°ç­‹è†œ", "æ‰‹è‡‚ç­‹è†œ", "è…¹éƒ¨ç­‹è†œ", "å¤§è…¿å‰å´", "å¤§è…¿å¾Œå´", "å¤§è…¿å…§å´", "å¤§è…¿å¤–å´", "å°è…¿å‰å´", "å°è…¿å¾Œå´", "å°è…¿å…§å´", "å°è…¿å¤–å´", "è‡€éƒ¨ç­‹è†œ", "è†é—œç¯€", "è¶³åº•", "å…¶ä»–"]],
      ["è¨“ç·´", ["é ¸æ·±è‚Œç¾¤", "è…¹éƒ¨æ ¸å¿ƒ", "éª¨ç›†åº•è‚Œ", "æ·±è‡€è‚Œç¾¤", "å¤§è…¿å‰å´", "å¤§è…¿å¾Œå´", "å¤§è…¿å…§å´", "å¤§è…¿å¤–å´", "å°è…¿å‰å´", "å°è…¿å¾Œå´", "å°è…¿å…§å´", "å°è…¿å¤–å´", "è¶³åº•", "å…¶ä»–"]],
      ["å…¶ä»–è™•ç†", ["è²¼ç´®","é¬†å‹•é—œç¯€","å…§è‡Ÿç­‹è†œé¬†å‹•", "ç¥ç¶“é¬†å‹•", "å…¶ä»–"]]
    ]
  },
  {
    title: "å›å®¶é‹å‹•",
    sections: [
      ["æ”¾é¬†*", ["æ»¾ç­’", "èŠ±ç”Ÿçƒ", "å…¶ä»–"]],
      ["ä¼¸å±•*", ["è‚©é ¸ç­‹è†œ", "èƒ¸è…°ç­‹è†œ", "æ‰‹è‡‚ç­‹è†œ", "è…¹éƒ¨ç­‹è†œ", "å¤§è…¿å‰å´", "å¤§è…¿å¾Œå´", "å¤§è…¿å…§å´", "å¤§è…¿å¤–å´", "å°è…¿å‰å´", "å°è…¿å¾Œå´", "å°è…¿å…§å´", "å°è…¿å¤–å´", "è‡€éƒ¨ç­‹è†œ", "è†é—œç¯€", "è¶³åº•", "å…¶ä»–"]],
      ["è¨“ç·´*", ["é ¸æ·±è‚Œç¾¤", "è…¹éƒ¨æ ¸å¿ƒ", "éª¨ç›†åº•è‚Œ", "æ·±è‡€è‚Œç¾¤", "å¤§è…¿å‰å´", "å¤§è…¿å¾Œå´", "å¤§è…¿å…§å´", "å¤§è…¿å¤–å´", "å°è…¿å‰å´", "å°è…¿å¾Œå´", "å°è…¿å…§å´", "å°è…¿å¤–å´", "è¶³åº•", "å…¶ä»–"]],
      ["å…¶ä»–*", ["å§¿æ…‹çŸ¯æ­£", "ç¥ç¶“å‹•æ…‹ä¼¸å±•", "å‘¼å¸è¨“ç·´", "å¹³è¡¡è¨“ç·´", "å†°æ•·", "ç†±æ•·", "å…¶ä»–"]]
    ]
  },
  {
    title: "å¾ŒçºŒè¦åŠƒ",
    sections: [
      ["ä¸‹æ¬¡è™•ç†æ–¹å‘", ["__text__"]],
      ["å»ºè­°è™•ç†æ™‚é–“(å¿…å¡«)", ["å·²å®‰æ’ï¼š","ä¸€é€±å¾Œ", "å…©é€±å¾Œ", "ä¸€å€‹æœˆå¾Œ", "å…¶ä»–"]],
      ["å…¶ä»–å»ºè­°", ["é‹å¢Šå»ºè­°", "è½‰ä»‹é†«å¸«", "å…¶ä»–"]]
    ]
  }
];

const form = document.getElementById("form");

blocks.forEach(block => {
  const blockTitle = document.createElement("div");
  blockTitle.className = "block-title";
  blockTitle.textContent = block.title;
  form.appendChild(blockTitle);

  const blockSection = document.createElement("div");
  blockSection.className = "block-section";
  blockSection.style.display = "block";
  form.appendChild(blockSection);

  blockTitle.onclick = () => {
    blockSection.style.display = blockSection.style.display === "none" ? "block" : "none";
  };

  block.sections.forEach(([sectionTitle, items]) => {
    const h3 = document.createElement("h3");
    h3.textContent = sectionTitle;
    const sectionDiv = document.createElement("div");
    sectionDiv.className = "section";

    const requiredSections = ["å»ºè­°è™•ç†æ™‚é–“(å¿…å¡«)", "åŸºæœ¬è³‡æ–™", "å®¢æˆ¶ä¸»è¨´", "ä¸‹æ¬¡è™•ç†æ–¹å‘"];
    sectionDiv.style.display = requiredSections.includes(sectionTitle) ? "block" : "none";

    h3.onclick = () => {
      sectionDiv.style.display = sectionDiv.style.display === "none" ? "block" : "none";
    };

    blockSection.appendChild(h3);
    blockSection.appendChild(sectionDiv);

    items.forEach(item => {
      const div = document.createElement("div");
      div.className = "item";

      if (block.title === "åŸºæœ¬è³‡æ–™") {
        if (item === "æœå‹™æ—¥æœŸ") {
          div.innerHTML = `<label>${item}</label><input type="date">`;
        } else if (item === "æ˜¯å¦ç‚ºç¬¬ä¸€æ¬¡æœå‹™") {
          div.innerHTML = `<label>${item}</label><select><option>æ˜¯</option><option>å¦</option></select>`;
        } else {
          div.innerHTML = `<label>${item}</label><input type="text">`;
        }
      } else if (item === "__text__") {
        div.innerHTML = `<label>è«‹å¡«å¯«ï¼š</label><input type="text">`;
     } else if (item === "é¬†å‹•é—œç¯€") {
    const checkboxId = "joint-mobility-" + Math.random().toString(36).substr(2, 5);
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" value="é¬†å‹•é—œç¯€">
      <label for="${checkboxId}">é¬†å‹•<input type="text" placeholder="å¡«å¯«éƒ¨ä½" style="width: 80px; display:none;">é—œç¯€</label>
    `;
    const checkbox = div.querySelector('input[type="checkbox"]');
    const input = div.querySelector('input[type="text"]');
    checkbox.addEventListener('change', (e) => {
      input.style.display = e.target.checked ? 'inline-block' : 'none';
    });
  } else {
    div.innerHTML = `<label><input type="checkbox" value="${item}"> ${item}</label><input type="text" placeholder="è£œå……ï¼ˆå¯ä¸å¡«ï¼‰" style="display:none">`;
    div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
      div.querySelector('input[type="text"]').style.display = e.target.checked ? 'inline-block' : 'none';
    });
  }

      sectionDiv.appendChild(div);
    });
  });
});

function getSectionText(title) {
  const h3 = [...document.querySelectorAll('h3')].find(h => h.textContent === title);
  if (!h3) return null;
  const section = h3.nextElementSibling;
  const items = [...section.querySelectorAll('.item')];
  return items.filter(i => i.querySelector('input[type="checkbox"]')?.checked).map(i => {
    const checkbox = i.querySelector('input[type="checkbox"]');
    const val = checkbox.value;
    const note = i.querySelector('input[type="text"]').value.trim();
    if (val === "å…¶ä»–") {
    return note || "å…¶ä»–";
  } else if (val === "é¬†å‹•é—œç¯€") {
    return note ? `é¬†å‹•${note}é—œç¯€` : "é¬†å‹•é—œç¯€";
  } else {
    return note ? `${val}ï¼ˆ${note}ï¼‰` : val;
  }
  });
}

function getFreeText(title) {
  const h3 = [...document.querySelectorAll('h3')].find(h => h.textContent === title);
  if (!h3) return "";
  const section = h3.nextElementSibling;
  const input = section.querySelector('input[type="text"]');
  return input?.value?.trim() || "";
}
  
function getSectionTextForPlan() {
  const title = "å»ºè­°è™•ç†æ™‚é–“(å¿…å¡«)";
  const h3 = [...document.querySelectorAll('h3')].find(h => h.textContent === title);
  if (!h3) return null;
  const section = h3.nextElementSibling;
  const items = [...section.querySelectorAll('.item')];

  return items
    .filter(i => i.querySelector('input[type="checkbox"]')?.checked)
    .map(i => {
      const checkbox = i.querySelector('input[type="checkbox"]');
      const val = checkbox.value;
      const note = i.querySelector('input[type="text"]').value.trim();

      if (val === "å·²å®‰æ’ï¼š" || val === "å…¶ä»–") {
        return note || val; // è£œå……å…§å®¹ç‚ºä¸»ï¼Œæ²’å¡«è£œå……å°±ä¿ç•™åŸæ–‡å­—
      } else {
        return note ? `${val}ï¼ˆ${note}ï¼‰` : val;
      }
    });
}

function getBasicData(title) {
  const h3 = [...document.querySelectorAll('h3')].find(h => h.textContent === "åŸºæœ¬è³‡æ–™");
  const section = h3?.nextElementSibling;
  const item = [...section.querySelectorAll('.item')].find(i => i.querySelector('label')?.textContent === title);
  const input = item?.querySelector('input, select');
  return input?.value || "";
}

function saveToSheets(data) {
  fetch("https://script.google.com/macros/s/AKfycbygMhLsVj-QQtAQ3l-4JaG6CkMsgsYBQnfFxCJYYvav-1k9a6FbUj2JuUAtuGL_tDL9Kg/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}

function generate() {
  const g = t => getSectionText(t);
  const client = getBasicData("å®¢æˆ¶åç¨±");
  const therapist = getBasicData("ç‰©ç†æ²»ç™‚å¸«åç¨±");
  const date = getBasicData("æœå‹™æ—¥æœŸ");
  const firstTime = getBasicData("æ˜¯å¦ç‚ºç¬¬ä¸€æ¬¡æœå‹™");
  const suggest = getSectionTextForPlan();
  const otherSuggest = g("å…¶ä»–å»ºè­°"); // â† åŠ åœ¨ generate() é–‹é ­çš„å€å¡Šä¸­

  if (!client || !therapist || !date || !firstTime) {
    alert("ã€åŸºæœ¬è³‡æ–™ã€‘ç‚ºå¿…å¡«ï¼Œè«‹å®Œæ•´å¡«å¯«ï¼");
    return;
  }

  if (!suggest) {
    alert("è«‹å‹¾é¸ã€å»ºè­°è™•ç†æ™‚é–“ã€‘ï¼");
    return;
  }

  let result = `${client}æ‚¨å¥½ï½æˆ‘æ˜¯ç‰©ç†æ²»ç™‚å¸«${therapist}ï¼Œæœ¬æ¬¡${date}è™•ç†çš„é‡é»ï½\n\n`;
  if (g("å®¢æˆ¶ä¸»è¨´")) result += `ğŸ”º æœ¬æ¬¡ä¸»è¨´ï¼š ${g("å®¢æˆ¶ä¸»è¨´").join('ã€')}\n\n`;

  const summary = [];
  if (g("éœæ…‹è©•ä¼°")?.length) summary.push(`- éœæ…‹è©•ä¼°ï¼š${g("éœæ…‹è©•ä¼°").join('ã€')}`);
  if (g("æ´»å‹•åº¦ä¸è¶³")?.length) summary.push(`- æ´»å‹•åº¦ä¸è¶³ï¼š${g("æ´»å‹•åº¦ä¸è¶³").join('ã€')}`);
  if (g("è‚Œè€åŠ›ä¸è¶³/åŠŸèƒ½å¤±å¸¸")?.length) summary.push(`- è‚Œè€åŠ›ä¸è¶³/åŠŸèƒ½å¤±å¸¸ï¼š${g("è‚Œè€åŠ›ä¸è¶³/åŠŸèƒ½å¤±å¸¸").join('ã€')}`);
  if (g("ç·Šç¹ƒç­‹è†œ")?.length) summary.push(`- ç·Šç¹ƒç­‹è†œï¼š${g("ç·Šç¹ƒç­‹è†œ").join('ã€')}`);
  if (summary.length) result += `ğŸ”º è©•ä¼°æ‘˜è¦ï¼š\n${summary.join('\n')}\n\n`;

  const process = [];
  if (g("æ”¾é¬†")?.length) process.push(`- æ”¾é¬†ï¼š${g("æ”¾é¬†").join('ã€')}`);
  if (g("ä¼¸å±•")?.length) process.push(`- ä¼¸å±•ï¼š${g("ä¼¸å±•").join('ã€')}`);
  if (g("è¨“ç·´")?.length) process.push(`- è¨“ç·´ï¼š${g("è¨“ç·´").join('ã€')}`);
  if (g("å…¶ä»–è™•ç†")?.length) process.push(`- ${g("å…¶ä»–è™•ç†").join('ã€')}`);
  if (process.length) result += `ğŸ”º æœ¬æ¬¡è™•ç†å…§å®¹ï¼š\n${process.join('\n')}\n\n`;
 
  const home = [];
  if (g("æ”¾é¬†*")?.length) home.push(`- æ”¾é¬†ï¼š${g("æ”¾é¬†*").join('ã€')}`);
 if (g("ä¼¸å±•*")?.length) home.push(`- ä¼¸å±•ï¼š${g("ä¼¸å±•*").join('ã€')}`);
  if (g("è¨“ç·´*")?.length) home.push(`- è‚ŒåŠ›è¨“ç·´ï¼š${g("è¨“ç·´*").join('ã€')}`);
  if (g("å…¶ä»–*")?.length) home.push(`- ${g("å…¶ä»–*").join('ã€')}`);
  if (home.length) result += `ğŸ”º å›å®¶é‹å‹•ï¼š\n${home.join('\n')}\n\n`;

  result += `ğŸ”º å…¶ä»–å»ºè­°ï¼š\nå›å®¶å¤šè£œå……æ°´åˆ†ã€Bç¾¤åŠ å¼·ä»£è¬ï¼Œç·©è§£ä¸é©ã€‚\nğŸ™Œ è·Ÿæ‚¨åˆ†äº«æœ€æ–°çš„æ´»å‹•ï¼Œå–œæ­¡æˆ‘å€‘çš„æœå‹™ä¹Ÿæ­¡è¿ä»‹ç´¹çµ¦è¦ªæœ‹å¥½å‹ï¼Œæ¯ä»‹ç´¹ä¸€ä½å³å¯å¾—ã€250å…ƒæŠ˜æŠµé‡‘ï¼ã€‘\n`;
if (otherSuggest && otherSuggest.length > 0) {
  result += `(p.s. ${otherSuggest.join('ã€')})\n`;
}
  const nextPlan = getFreeText("ä¸‹æ¬¡è™•ç†æ–¹å‘");
  if (nextPlan) {
    result += `ğŸ”º é è¨ˆä¸‹æ¬¡è™•ç†æ–¹å‘ç‚ºï¼š${nextPlan}\n`;
  }
  result += `æœŸå¾…${suggest.join('ã€')}æŒçºŒç‚ºæ‚¨è™•ç†ï½\n`;

  document.getElementById("output").value = result;

  saveToSheets({
    client, therapist, date, firstTime,
    mainComplaint: g("å®¢æˆ¶ä¸»è¨´")?.join("ã€") || "",
    staticEval: g("éœæ…‹è©•ä¼°")?.join("ã€") || "",
    dynamicLimit: g("æ´»å‹•åº¦ä¸è¶³")?.join("ã€") || "",
    dynamicStrength: g("è‚Œè€åŠ›ä¸è¶³/åŠŸèƒ½å¤±å¸¸")?.join("ã€") || "",
    fascia: g("ç·Šç¹ƒç­‹è†œ")?.join("ã€") || "",
    relax: g("æ”¾é¬†")?.join("ã€") || "",
    stretch: g("ä¼¸å±•")?.join("ã€") || "",
    train: g("è¨“ç·´")?.join("ã€") || "",
    special: g("å…¶ä»–è™•ç†")?.join("ã€") || "",
    homeSelfRelax: g("æ”¾é¬†*")?.join("ã€") || "",
    homeYoga: g("ä¼¸å±•*")?.join("ã€") || "",
    homeTrain: g("è¨“ç·´*")?.join("ã€") || "",
    homeOther: g("å…¶ä»–*")?.join("ã€") || "",
    nextPlan: getFreeText("ä¸‹æ¬¡è™•ç†æ–¹å‘"),
    planSuggest: suggest.join("ã€"),
    otherSuggest: g("å…¶ä»–å»ºè­°")?.join("ã€") || "",
    output: result
  });
}

function copyText() {
  const textArea = document.getElementById("output");
  textArea.select();
  document.execCommand("copy");
  alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
}
</script>

</body>
</html>
