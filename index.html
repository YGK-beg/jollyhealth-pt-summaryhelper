<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>揪你健康 服務紀錄產生器（區塊化版本）</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; max-width: 600px; margin: auto; }
.block-title { margin-top: 30px; cursor: pointer; background: #ccc; padding: 12px; font-size: 18px; font-weight: bold; }
h3 { margin-top: 20px; cursor: pointer; background: #eee; padding: 10px; font-size: 16px; }
.section, .block-section { display: none; margin-bottom: 20px; }
.item { margin-bottom: 12px; display: flex; align-items: center; flex-wrap: wrap; }
.item label { flex: 1 1 120px; }
.item input[type="text"], .item input[type="date"], .item select { flex: 2 1 200px; margin-left: 5px; }
textarea { width: 100%; height: 200px; }
button { margin: 10px 0; padding: 10px 20px; width: 100%; }
</style>
</head>
<body>

<h1>揪你健康 服務紀錄產生器</h1>

<div id="form"></div>

<button onclick="generate()">產生文案</button>
<button onclick="copyText()">複製文案</button>

<h2>生成文案</h2>
<textarea id="output"></textarea>

<script>
const blocks = [
  {
    title: "基本資料",
    sections: [
       ["客戶名稱", "物理治療師名稱", "服務日期", "是否為第一次服務"]
    ]
  },
  {
    title: "主訴與評估",
    sections: [
      ["客戶主訴", ["頸部", "背部", "腰部", "腹部", "肩膀", "手肘", "手腕", "髖", "膝", "踝", "其他"]],
      ["靜態評估", ["脖子前傾", "高低肩", "駝背", "腰椎前凸", "脊柱側彎", "骨盆前傾", "骨盆後傾", "長短腳", "膝內翻", "膝外翻", "足內翻", "足外翻", "扁平足", "高弓足", "其他"]],
      ["活動度不足", ["頸部", "背部", "腰部", "腹部", "肩膀", "手肘", "手腕", "髖", "膝", "踝", "其他"]],
      ["肌耐力不足/功能失常", ["頸部", "背部", "腰部", "腹部", "肩膀", "手肘", "手腕", "髖", "膝", "踝", "其他"]],
      ["緊繃筋膜", ["頸部", "背部", "腰部", "腹部", "肩膀", "手肘", "手腕", "髖", "膝", "踝", "其他"]]
    ]
  },
  {
    title: "本次處理",
    sections: [
      ["本次放鬆", ["肩頸筋膜", "胸腰筋膜", "手臂筋膜", "腹部筋膜", "大腿前側", "大腿後側", "大腿內側", "大腿外側", "小腿前側", "小腿後側", "臀部筋膜", "膝關節", "足底", "其他"]],
      ["本次伸展", ["肩頸筋膜", "胸腰筋膜", "手臂筋膜", "腹部筋膜", "大腿前側", "大腿後側", "大腿內側", "大腿外側", "小腿前側", "小腿後側", "臀部筋膜", "膝關節", "足底", "其他"]],
      ["本次訓練", ["頸深肌群", "腹部核心", "骨盆底肌", "深臀肌群", "大腿前側", "大腿後側", "小腿前側", "小腿後側", "其他"]],
      ["其他處理", ["內臟筋膜鬆動", "神經鬆動", "其他"]]
    ]
  },
  {
    title: "回家功課",
    sections: [
      ["回家功課-瑜珈伸展", ["肩頸筋膜", "胸腰筋膜", "手臂筋膜", "腹部筋膜", "大腿前側", "大腿後側", "大腿內側", "大腿外側", "小腿前側", "小腿後側", "臀部筋膜", "膝關節", "足底", "其他"]],
      ["回家功課-訓練", ["頸深肌群", "腹部核心", "骨盆底肌", "深臀肌群", "大腿前側", "大腿後側", "小腿前側", "小腿後側", "其他"]],
      ["回家功課-其他", ["姿態矯正", "神經動態伸展", "呼吸訓練", "平衡訓練", "其他"]]
    ]
  },
  {
    title: "後續規劃",
    sections: [
      ["建議處理時間", ["一週內", "兩週內", "一個月內", "其他"]],
      ["其他建議", ["鞋墊建議", "轉介醫師", "其他"]]
    ]
  }
];

const form = document.getElementById("form");

blocks.forEach(block => {
  const blockTitle = document.createElement("div");
  blockTitle.className = "block-title";
  blockTitle.textContent = block.title;
  form.appendChild(blockTitle);

  const blockSection = document.createElement("div");
  blockSection.className = "block-section";
  blockSection.style.display = "block"; // 讓所有區塊預設展開
  form.appendChild(blockSection);

  blockTitle.onclick = () => {
    blockSection.style.display = blockSection.style.display === "none" ? "block" : "none";
  };

  block.sections.forEach(section => {
  let sectionTitle, items;// 若為基本資料區塊（不是二層陣列）


  // 檢查是否為基本資料（只有一層，不需要 sectionTitle）
  if (block.title === "基本資料" && !Array.isArray(section[0])) {
    sectionTitle = null;
    items = section;
  } else {
    [sectionTitle, items] = section;
  }

  const sectionDiv = document.createElement("div");
  sectionDiv.className = "section";

  // 預設展開的設定
  const requiredSections = ["建議處理時間", "客戶主訴"];
  sectionDiv.style.display = sectionTitle && requiredSections.includes(sectionTitle) ? "block" : "none";
  if (block.title === "基本資料") sectionDiv.style.display = "block";

  // h3 標題
  if (sectionTitle) {
    const h3 = document.createElement("h3");
    h3.textContent = sectionTitle;
    h3.onclick = () => {
      sectionDiv.style.display = sectionDiv.style.display === "none" ? "block" : "none";
    };
    blockSection.appendChild(h3);
  }

  blockSection.appendChild(sectionDiv);

  items.forEach(item => {
    const div = document.createElement("div");
    div.className = "item";

    if (block.title === "基本資料") {
      if (item === "服務日期") {
        div.innerHTML = `<label>${item}</label><input type="date">`;
      } else if (item === "是否為第一次服務") {
        div.innerHTML = `<label>${item}</label><select><option>是</option><option>否</option></select>`;
      } else {
        div.innerHTML = `<label>${item}</label><input type="text">`;
      }
    } else {
      div.innerHTML = `<label><input type="checkbox" value="${item}"> ${item}</label> <input type="text" placeholder="補充（可不填）">`;
      div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
        div.querySelector('input[type="text"]').style.display = e.target.checked ? 'inline-block' : 'none';
      });
    }

    sectionDiv.appendChild(div);
  });
});

function getSectionText(title) {
    const section = [...document.querySelectorAll('h2')].find(h2 => h2.textContent === title).nextElementSibling;
    const items = [...section.querySelectorAll('.item')];
    const result = items.filter(i => i.querySelector('input[type="checkbox"]')?.checked)
                                            .map(i => {
        const val = i.querySelector('input[type="checkbox"]').value;
        const note = i.querySelector('input[type="text"]').value.trim();
        return note ? `${val}（${note}）` : val;
    });
    return result.length > 0 ? result : null;
}

function getSectionTextForPlan() {
    const section = [...document.querySelectorAll('h2')].find(h2 => h2.textContent === "建議處理時間").nextElementSibling;
    const items = [...section.querySelectorAll('.item')];
    const result = [];

    items.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const text = item.querySelector('input[type="text"]');
        
        if (checkbox.checked) {
            if (checkbox.value === "其他") {
                if (text.value.trim() !== "") result.push(text.value.trim());
            } else {
                result.push(text.value.trim() !== "" ? `${checkbox.value}（${text.value.trim()}）` : checkbox.value);
            }
        }
    });

    return result.length > 0 ? result : null;
}
    
function getBasicData(title) {
    const section = [...document.querySelectorAll('h2')].find(h2 => h2.textContent === "基本資料").nextElementSibling;
    const items = [...section.querySelectorAll('.item')];
    const input = items.find(i => i.querySelector('label').textContent === title)?.querySelector('input, select');
    return input?.value || "";
}

function saveToSheets(data) {
  fetch("https://script.google.com/macros/s/AKfycbww-xgBPVb0vj8xuXXXtFPs7WAV9MmUeGCApyWRtdlXqjafIi-tJQBlN7KZV_QWLSemRw/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}
    
function generate() {
    const g = t => getSectionText(t);

    const client = getBasicData("客戶名稱");
    const therapist = getBasicData("物理治療師名稱");
    const date = getBasicData("服務日期");
    const firstTime = getBasicData("是否為第一次服務");
    const suggest = getSectionTextForPlan();

    if (!client || !therapist || !date || !firstTime) {
        alert("【基本資料】為必填，請完整填寫！");
        return;
    }

    if (!suggest) {
        alert("請勾選【建議處理時間】！");
        return;
    }

    let result = `${client}您好～我是物理治療師${therapist}，本次${date}處理的重點～\n`;

    if (g('客戶主訴')) result += `🔺 ${g('客戶主訴').join('、')}\n\n`;

    const summary = [];
    if (g('靜態評估')) summary.push(`- 靜態評估：${g('靜態評估').join('、')}`);
    if (g('活動度不足')) summary.push(`- 活動度不足：${g('活動度不足').join('、')}`);
    if (g('肌耐力不足/功能失常')) summary.push(`- 肌耐力不足/功能失常：${g('肌耐力不足/功能失常').join('、')}`);
    if (g('緊繃筋膜')) summary.push(`- 緊繃筋膜：${g('緊繃筋膜').join('、')}`);
    if (summary.length) result += `🔺 評估摘要：\n${summary.join('\n')}\n\n`;

    const process = [];
    if (g('本次放鬆')) process.push(`- 放鬆：${g('本次放鬆').join('、')}`);
    if (g('本次伸展')) process.push(`- 伸展：${g('本次伸展').join('、')}`);
    if (g('本次訓練')) process.push(`- 訓練：${g('本次訓練').join('、')}`);
    if (g('其他處理')) process.push(`- 特殊：${g('其他處理').join('、')}`);
    if (process.length) result += `🔺 本次處理內容：\n${process.join('\n')}\n\n`;

    const home = [];
    if (g('回家功課-瑜珈伸展')) home.push(`- 瑜珈伸展：${g('回家功課-瑜珈伸展').join('、')}`);
    if (g('回家功課-訓練')) home.push(`- 肌力訓練：${g('回家功課-訓練').join('、')}`);
    if (g('回家功課-其他')) home.push(`- 其他：${g('回家功課-其他').join('、')}`);
    if (home.length) result += `🔺 回家運動：\n${home.join('\n')}\n\n`;

    result += `🔺 其他建議：\n回家多補充水分、B群加強代謝，緩解不適。\n🙌 跟您分享最新的活動，喜歡我們的服務也歡迎介紹給親朋好友，每介紹一位即可得【250元折抵金！】\n`;

    if (g('其他建議')) result += `(p.s. ${g('其他建議').join('、')})\n`;

    result += `建議預約${suggest.join('、')}持續處理，目前${therapist}老師有空檔的時間`;

    document.getElementById('output').value = result;

    const saveData = {
  client, therapist, date, firstTime,
  mainComplaint: g('客戶主訴')?.join('、') || "",
  staticEval: g('靜態評估')?.join('、') || "",
  dynamicLimit: g('活動度不足')?.join('、') || "",
  dynamicStrength: g('肌耐力不足/功能失常')?.join('、') || "",
  fascia: g('緊繃筋膜')?.join('、') || "",
  relax: g('本次放鬆')?.join('、') || "",
  stretch: g('本次伸展')?.join('、') || "",
  train: g('本次訓練')?.join('、') || "",
  special: g('其他處理')?.join('、') || "",
  homeYoga: g('回家功課-瑜珈伸展')?.join('、') || "",
  homeTrain: g('回家功課-訓練')?.join('、') || "",
  homeOther: g('回家功課-其他')?.join('、') || "",
  otherSuggest: g('其他建議')?.join('、') || "",
  planSuggest: g('建議處理時間')?.join('、') || "",
  output: document.getElementById('output').value
};

saveToSheets(saveData);

    
}

function copyText() {
    const textArea = document.getElementById('output');
    textArea.select();
    document.execCommand('copy');
    alert("已複製到剪貼簿！");
}
</script>

</body>
</html>
